# ğŸ”„ æµå¼è¾“å‡ºè°ƒè¯•åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æˆ‘å·²ç»ä¸ºä½ çš„ VLLM æ¨¡å‹æ·»åŠ äº†è¯¦ç»†çš„æµå¼è¾“å‡ºè°ƒè¯•åŠŸèƒ½ï¼Œç°åœ¨ä½ å¯ä»¥ï¼š

- ğŸ“¦ æŸ¥çœ‹æ¯ä¸ª chunk çš„è¯¦ç»†ä¿¡æ¯ï¼ˆç¼–å·ã€é•¿åº¦ã€å†…å®¹ï¼‰
- ğŸ“Š è·å–æµå¼å“åº”çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ€» chunk æ•°ã€æ€»é•¿åº¦ã€è€—æ—¶ç­‰ï¼‰
- ğŸ” åˆ†æå“åº”çš„ç”Ÿæˆæ¨¡å¼å’Œæ€§èƒ½
- ğŸ¯ è°ƒè¯•æµå¼è¾“å‡ºçš„é—®é¢˜

## âœ… å·²ä¿®æ”¹çš„æ–‡ä»¶

### 1. æ ¸å¿ƒæ¨¡å‹æ–‡ä»¶
- `agno/models/base.py` - æ·»åŠ äº†æµå¼è°ƒè¯•åŠŸèƒ½
- `agno/models/aws/bedrock.py` - ä¸º AWS Bedrock æ·»åŠ è°ƒè¯•

### 2. è°ƒè¯•å·¥å…·
- `stream_debug_utils.py` - å®Œæ•´çš„æµå¼è°ƒè¯•å·¥å…·ç±»
- `test_stream_debug.py` - æµ‹è¯•è„šæœ¬
- `run.py` - å·²å¯ç”¨è°ƒè¯•çš„ç¤ºä¾‹

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1ï¼šåœ¨ä»£ç ä¸­å¯ç”¨è°ƒè¯•

```python
from agno.agent import Agent
from agno.models.vllm import VLLM
from stream_debug_utils import enable_stream_debug

# å¯ç”¨è¯¦ç»†è°ƒè¯•æ¨¡å¼
enable_stream_debug(verbose=True)

# åˆ›å»ºä½ çš„æ¨¡å‹å’Œ Agent
model = VLLM(
    id='Qwen3-Omni-Thinking',
    base_url='http://223.109.239.14:10026/v1/',
    max_tokens=32768
)

agent = Agent(
    model=model,
    tool_choice="none",
    markdown=True,
)

# ä½¿ç”¨æµå¼è¾“å‡º - ç°åœ¨ä¼šæ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
agent.print_response("ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±", stream=True)
```

### æ–¹æ³•2ï¼šè¿è¡Œç°æœ‰çš„æµ‹è¯•è„šæœ¬

```bash
# è¿è¡Œå·²é…ç½®å¥½çš„æµ‹è¯•
python run.py

# æˆ–è¿è¡Œä¸“é—¨çš„æµ‹è¯•è„šæœ¬
python test_stream_debug.py
```

## ğŸ“Š è°ƒè¯•è¾“å‡ºç¤ºä¾‹

å¯ç”¨è°ƒè¯•åï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è¾“å‡ºï¼š

```
ğŸš€ å¼€å§‹æµå¼å“åº” [VLLM] - 14:30:25
============================================================
ğŸ“¦ Chunk #001 | é•¿åº¦:  15 | ç´¯è®¡:   15
   å†…å®¹: ä½ å¥½ï¼æˆ‘æ˜¯ä¸€ä¸ª
ğŸ“¦ Chunk #002 | é•¿åº¦:  12 | ç´¯è®¡:   27  
   å†…å®¹: AIåŠ©æ‰‹ï¼Œå¾ˆé«˜å…´
ğŸ“¦ Chunk #003 | é•¿åº¦:  18 | ç´¯è®¡:   45
   å†…å®¹: ä¸ºä½ æä¾›å¸®åŠ©ã€‚æˆ‘å¯ä»¥
   ğŸ”„ åŒ…å«æ¢è¡Œç¬¦
ğŸ“¦ Chunk #004 | é•¿åº¦:  20 | ç´¯è®¡:   65
   å†…å®¹: å›ç­”é—®é¢˜ã€ååŠ©åˆ†æã€
   ğŸ“ åŒ…å«å¥å­ç»“æŸç¬¦
============================================================
âœ… æµå¼å“åº”å®Œæˆ - 14:30:28
ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:
   â€¢ æ€» chunk æ•°: 4
   â€¢ æ€»å†…å®¹é•¿åº¦: 65 å­—ç¬¦
   â€¢ è€—æ—¶: 2.34 ç§’
   â€¢ å¹³å‡ chunk å¤§å°: 16.3 å­—ç¬¦
   â€¢ å¹³å‡ chunk é—´éš”: 585.0 æ¯«ç§’
```

## ğŸ›ï¸ è°ƒè¯•æ¨¡å¼

### è¯¦ç»†æ¨¡å¼ (verbose=True)
```python
enable_stream_debug(verbose=True)
```
- æ˜¾ç¤ºå®Œæ•´çš„ chunk å†…å®¹
- æ˜¾ç¤ºå“åº”å¯¹è±¡çš„ç±»å‹å’Œå±æ€§
- æ˜¾ç¤ºç‰¹æ®Šå†…å®¹æ ‡è®°ï¼ˆæ¢è¡Œç¬¦ã€å¥å­ç»“æŸç¬¦ç­‰ï¼‰

### ç®€æ´æ¨¡å¼ (verbose=False)
```python
enable_stream_debug(verbose=False)
```
- åªæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯å’Œå†…å®¹é¢„è§ˆ
- é€‚åˆç”Ÿäº§ç¯å¢ƒæˆ–é•¿å“åº”çš„è°ƒè¯•

### ç¦ç”¨è°ƒè¯•
```python
from stream_debug_utils import disable_stream_debug
disable_stream_debug()
```

## ğŸ”§ é«˜çº§åŠŸèƒ½

### æ‰‹åŠ¨æ§åˆ¶è°ƒè¯•è¿‡ç¨‹

```python
from stream_debug_utils import StreamDebugger

# åˆ›å»ºè‡ªå®šä¹‰è°ƒè¯•å™¨
debugger = StreamDebugger(enabled=True, verbose=True)

# æ‰‹åŠ¨å¼€å§‹è°ƒè¯•
debugger.start_stream("My Custom Model")

# åœ¨ä½ çš„æµå¼å¾ªç¯ä¸­
for chunk in your_stream:
    debugger.log_chunk(chunk)

# ç»“æŸè°ƒè¯•
debugger.end_stream()
```

### åˆ†æç‰¹å®šçš„å“åº”æ¨¡å¼

è°ƒè¯•è¾“å‡ºä¼šè‡ªåŠ¨æ ‡è®°ï¼š
- ğŸ”„ åŒ…å«æ¢è¡Œç¬¦çš„ chunk
- ğŸ“ åŒ…å«å¥å­ç»“æŸç¬¦çš„ chunk  
- ğŸ“¦ æ— å†…å®¹çš„å…ƒæ•°æ® chunk

## ğŸ¯ å®é™…åº”ç”¨åœºæ™¯

### 1. æ€§èƒ½åˆ†æ
- æŸ¥çœ‹ chunk å¤§å°åˆ†å¸ƒ
- åˆ†æå“åº”å»¶è¿Ÿæ¨¡å¼
- ä¼˜åŒ–æµå¼è¾“å‡ºä½“éªŒ

### 2. é—®é¢˜è¯Šæ–­
- æ£€æŸ¥æ˜¯å¦æœ‰ä¸¢å¤±çš„ chunk
- éªŒè¯å†…å®¹å®Œæ•´æ€§
- è°ƒè¯•æµå¼ä¸­æ–­é—®é¢˜

### 3. æ¨¡å‹æ¯”è¾ƒ
- æ¯”è¾ƒä¸åŒæ¨¡å‹çš„æµå¼è¾“å‡ºæ¨¡å¼
- åˆ†æå“åº”è´¨é‡å’Œé€Ÿåº¦

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½å½±å“**ï¼šè°ƒè¯•æ¨¡å¼ä¼šå¢åŠ ä¸€äº›è¾“å‡ºå¼€é”€ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ç®€æ´æ¨¡å¼æˆ–ç¦ç”¨
2. **å†…å®¹é•¿åº¦**ï¼šå¯¹äºå¾ˆé•¿çš„å“åº”ï¼Œå»ºè®®ä½¿ç”¨ç®€æ´æ¨¡å¼é¿å…æ§åˆ¶å°è¾“å‡ºè¿‡å¤š
3. **ç¼–ç é—®é¢˜**ï¼šç¡®ä¿æ§åˆ¶å°æ”¯æŒ UTF-8 ç¼–ç ä»¥æ­£ç¡®æ˜¾ç¤ºä¸­æ–‡å†…å®¹

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¦‚æœè°ƒè¯•ä¿¡æ¯æ²¡æœ‰æ˜¾ç¤º

1. **æ£€æŸ¥å¯¼å…¥**ï¼š
   ```python
   try:
       from stream_debug_utils import enable_stream_debug
       enable_stream_debug(verbose=True)
       print("âœ… è°ƒè¯•å·²å¯ç”¨")
   except ImportError as e:
       print(f"âŒ å¯¼å…¥å¤±è´¥: {e}")
   ```

2. **æ£€æŸ¥æµå¼è¾“å‡º**ï¼š
   ç¡®ä¿ä½ ä½¿ç”¨çš„æ˜¯ `stream=True`ï¼š
   ```python
   agent.print_response("test", stream=True)  # âœ… æ­£ç¡®
   agent.print_response("test", stream=False) # âŒ ä¸ä¼šè§¦å‘è°ƒè¯•
   ```

3. **æ£€æŸ¥æ¨¡å‹æ”¯æŒ**ï¼š
   ç¡®ä¿ä½ çš„æ¨¡å‹æ”¯æŒæµå¼è¾“å‡º

### å¦‚æœè¾“å‡ºæ ¼å¼å¼‚å¸¸

- æ£€æŸ¥æ§åˆ¶å°ç¼–ç è®¾ç½®
- å°è¯•ç®€æ´æ¨¡å¼ï¼š`enable_stream_debug(verbose=False)`
- æ£€æŸ¥ Python ç‰ˆæœ¬å…¼å®¹æ€§

## ğŸ‰ å¼€å§‹ä½¿ç”¨

ç°åœ¨ä½ å¯ä»¥è¿è¡Œ `python run.py` æ¥æµ‹è¯•æµå¼è¾“å‡ºè°ƒè¯•åŠŸèƒ½ï¼

ä½ å°†çœ‹åˆ°æ¯ä¸ª chunk çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å’Œä¼˜åŒ–ä½ çš„ VLLM æ¨¡å‹çš„æµå¼å“åº”ã€‚
